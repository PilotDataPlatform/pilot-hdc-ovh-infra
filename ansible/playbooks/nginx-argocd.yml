---
- name: Setup nginx reverse proxy for Argo CD
  hosts: nginx-dev
  become: true
  vars_files:
    - ../vars/sensitive.yml
  tasks:
    - name: Create WebSocket map config
      copy:
        dest: /etc/nginx/conf.d/websocket-map.conf
        content: |
          map $http_upgrade $connection_upgrade {
              default upgrade;
              '' close;
          }
      notify: Reload nginx

    - name: Create rate limit zone config
      copy:
        dest: /etc/nginx/conf.d/rate-limit-argocd.conf
        content: |
          limit_req_zone $binary_remote_addr zone=argocd_login:10m rate=5r/s;
      notify: Reload nginx

    - name: Create Argo CD nginx config
      copy:
        dest: /etc/nginx/sites-available/argocd.conf
        content: |
          upstream argocd_servers {
          {% for node in nginx_hosts.dev.k8s_nodes %}
              server {{ node }}:30443;
          {% endfor %}
          }

          server {
              listen 443 ssl http2;
              listen [::]:443 ssl http2;
              server_name argocd.dev.hdc.ebrains.eu;

              ssl_certificate /etc/letsencrypt/live/{{ cert_name }}/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/live/{{ cert_name }}/privkey.pem;
              include /etc/letsencrypt/options-ssl-nginx.conf;
              ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

              server_tokens off;
              client_max_body_size 10M;

              # Security headers
              add_header X-Frame-Options "DENY" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
              add_header Referrer-Policy "strict-origin-when-cross-origin" always;
              add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

              # Rate limit only login endpoint.
              # TODO remove this once fail2ban is in place
              location = /api/v1/session {
                  limit_req zone=argocd_login burst=5 nodelay;

                  proxy_pass https://argocd_servers;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  # TODO turn it on once cert-manager is properly setup
                  proxy_ssl_verify off;
              }

              location / {
                  proxy_pass https://argocd_servers;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;

                  # Proxy timeouts
                  proxy_connect_timeout 60s;
                  proxy_send_timeout 60s;
                  proxy_read_timeout 3600s;

                  # WebSocket support for Argo UI
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection $connection_upgrade;

                  # Skip verification of Argo's self-signed cert
                  # TODO turn it on once cert-manager is properly setup
                  proxy_ssl_verify off;
              }
          }

          server {
              listen 80;
              listen [::]:80;
              server_name argocd.dev.hdc.ebrains.eu;
              return 301 https://$host$request_uri;
          }
      notify: Reload nginx

    - name: Enable Argo CD site
      file:
        src: /etc/nginx/sites-available/argocd.conf
        dest: /etc/nginx/sites-enabled/argocd.conf
        state: link
      notify: Reload nginx

  handlers:
    - name: Reload nginx
      service:
        name: nginx
        state: reloaded
