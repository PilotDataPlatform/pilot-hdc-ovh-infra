---
# NFS Server Setup
#
# NOT included in site.yml — run separately via: make ansible-nfs
#
# Bootstrap order: DNS → nfs-server.yml → ssh-hardening (always last).
# dist-upgrade may reboot; hardening must run after system is stable.
#
# Prerequisites:
#   1. Terraform: add deploy_nfs=true to dev tfvars, make apply-dev
#   2. OVH Console: attach block volume to NFS instance
#   3. sensitive.yml: add nfs_hosts.dev.ip (private IP from TF nfs_addresses output)
#   4. Bootstrap DNS + NFS (first run only, VM still on port 22):
#      cd ansible && ansible-playbook playbooks/dns-setup.yml -l nfs \
#        -e ssh_port=22 -e @vars/sensitive.yml
#      make ansible-nfs EXTRA_ARGS="-e ssh_port=22"
#   5. SSH hardening (AFTER nfs-server.yml, always last):
#      cd ansible && ansible-playbook playbooks/ssh-hardening.yml -l nfs \
#        -e ssh_port=22 -e @vars/sensitive.yml
#   6. Subsequent runs: make ansible-nfs
#
- hosts: nfs
  become: true

  tasks:
    - name: Update and upgrade apt packages
      apt:
        upgrade: dist
        update_cache: true

    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Reboot if required after dist-upgrade
      reboot:
        msg: "Reboot after dist-upgrade"
        post_reboot_delay: 30
      when: reboot_required.stat.exists

    - name: Verify block device exists
      stat:
        path: "{{ nfs_block_device | default('/dev/sdb') }}"
      register: block_dev

    - name: Fail if block device not found
      fail:
        msg: >
          Block device {{ nfs_block_device | default('/dev/sdb') }} not found.
          Attach the volume in OVH Console and verify with lsblk.
      when: not block_dev.stat.exists

    - name: Create ext4 filesystem on data volume
      filesystem:
        fstype: ext4
        dev: "{{ nfs_block_device | default('/dev/sdb') }}"

    - name: Mount data volume
      mount:
        path: /nfs/export
        src: "{{ nfs_block_device | default('/dev/sdb') }}"
        fstype: ext4
        opts: defaults
        state: mounted

    - name: Set export directory permissions
      file:
        path: /nfs/export
        state: directory
        mode: "0755"

    - name: Install NFS packages
      apt:
        pkg:
          - nfs-common
          - nfs-kernel-server
        update_cache: true

    - name: Configure exports
      template:
        src: ../templates/exports.j2
        dest: /etc/exports
      notify: restart nfs

  handlers:
    - name: restart nfs
      service:
        name: nfs-kernel-server
        state: restarted
        enabled: true
